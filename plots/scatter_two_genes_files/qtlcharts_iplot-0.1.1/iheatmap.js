// Generated by CoffeeScript 1.9.1
var iheatmap;

iheatmap = function(widgetdiv, data, chartOpts) {
  var axispos, cells, chartdivid, colors, formatX, formatY, g_heatmap, g_horslice, g_verslice, hbot, height, horcurvefunc, horslice, htop, margin, myheatmap, nullcolor, nxticks, nyticks, nzticks, plotHor, plotVer, rectcolor, ref, ref1, ref10, ref11, ref12, ref13, ref14, ref15, ref16, ref17, ref18, ref19, ref2, ref20, ref21, ref22, ref23, ref24, ref25, ref26, ref3, ref4, ref5, ref6, ref7, ref8, ref9, removeHor, removeVer, strokecolor, strokewidth, svg, title, titlepos, vercurvefunc, verslice, width, wleft, wright, xdif, xlab, xlim, xticks, ydif, ylab, ylim, yticks, zlab, zlim, zthresh, zticks;
  height = (ref = chartOpts != null ? chartOpts.height : void 0) != null ? ref : 800;
  width = (ref1 = chartOpts != null ? chartOpts.width : void 0) != null ? ref1 : 800;
  htop = (ref2 = chartOpts != null ? chartOpts.htop : void 0) != null ? ref2 : height / 2;
  wleft = (ref3 = chartOpts != null ? chartOpts.wleft : void 0) != null ? ref3 : width / 2;
  margin = (ref4 = chartOpts != null ? chartOpts.margin : void 0) != null ? ref4 : {
    left: 60,
    top: 40,
    right: 40,
    bottom: 40,
    inner: 5
  };
  axispos = (ref5 = chartOpts != null ? chartOpts.axispos : void 0) != null ? ref5 : {
    xtitle: 25,
    ytitle: 30,
    xlabel: 5,
    ylabel: 5
  };
  titlepos = (ref6 = chartOpts != null ? chartOpts.titlepos : void 0) != null ? ref6 : 20;
  rectcolor = (ref7 = chartOpts != null ? chartOpts.rectcolor : void 0) != null ? ref7 : "#E6E6E6";
  nullcolor = (ref8 = chartOpts != null ? chartOpts.nullcolor : void 0) != null ? ref8 : "#E6E6E6";
  strokecolor = (ref9 = chartOpts != null ? chartOpts.strokecolor : void 0) != null ? ref9 : "slateblue";
  strokewidth = (ref10 = chartOpts != null ? chartOpts.strokewidth : void 0) != null ? ref10 : 2;
  xlim = (ref11 = chartOpts != null ? chartOpts.xlim : void 0) != null ? ref11 : null;
  ylim = (ref12 = chartOpts != null ? chartOpts.ylim : void 0) != null ? ref12 : null;
  nxticks = (ref13 = chartOpts != null ? chartOpts.nxticks : void 0) != null ? ref13 : 5;
  xticks = (ref14 = chartOpts != null ? chartOpts.xticks : void 0) != null ? ref14 : null;
  nyticks = (ref15 = chartOpts != null ? chartOpts.nyticks : void 0) != null ? ref15 : 5;
  yticks = (ref16 = chartOpts != null ? chartOpts.yticks : void 0) != null ? ref16 : null;
  nzticks = (ref17 = chartOpts != null ? chartOpts.nzticks : void 0) != null ? ref17 : 5;
  zticks = (ref18 = chartOpts != null ? chartOpts.zticks : void 0) != null ? ref18 : null;
  title = (ref19 = chartOpts != null ? chartOpts.title : void 0) != null ? ref19 : "";
  xlab = (ref20 = chartOpts != null ? chartOpts.xlab : void 0) != null ? ref20 : "X";
  ylab = (ref21 = chartOpts != null ? chartOpts.ylab : void 0) != null ? ref21 : "Y";
  zlab = (ref22 = chartOpts != null ? chartOpts.zlab : void 0) != null ? ref22 : "Z";
  zthresh = (ref23 = chartOpts != null ? chartOpts.zthresh : void 0) != null ? ref23 : null;
  zlim = (ref24 = chartOpts != null ? chartOpts.zlim : void 0) != null ? ref24 : [-matrixMaxAbs(data.z), 0, matrixMaxAbs(data.z)];
  colors = (ref25 = chartOpts != null ? chartOpts.colors : void 0) != null ? ref25 : ["slateblue", "white", "crimson"];
  chartdivid = (ref26 = chartOpts != null ? chartOpts.chartdivid : void 0) != null ? ref26 : 'chart';
  hbot = height - htop;
  wright = width - wleft;
  svg = d3.select(widgetdiv).select("svg");
  if (xlim == null) {
    xlim = d3.extent(data.x);
    xdif = (data.x[1] - data.x[0]) / 2;
    xlim[0] -= xdif;
    xlim[1] += xdif;
  }
  if (ylim == null) {
    ylim = d3.extent(data.y);
    ydif = (data.y[1] - data.y[0]) / 2;
    ylim[0] -= ydif;
    ylim[1] += ydif;
  }
  myheatmap = heatmap().width(wleft - margin.left - margin.right).height(htop - margin.top - margin.bottom).margin(margin).axispos(axispos).titlepos(titlepos).rectcolor(rectcolor).xlim(xlim).ylim(ylim).nxticks(nxticks).xticks(xticks).nyticks(nyticks).yticks(yticks).xlab(xlab).ylab(ylab).zlim(zlim).zthresh(zthresh).colors(colors).nullcolor(nullcolor);
  horslice = curvechart().width(wleft - margin.left - margin.right).height(hbot - margin.top - margin.bottom).margin(margin).axispos(axispos).titlepos(titlepos).rectcolor(rectcolor).xlim(xlim).ylim(d3.extent(zlim)).nxticks(nxticks).xticks(xticks).nyticks(nzticks).yticks(zticks).xlab(xlab).ylab(zlab).strokecolor("").commonX(true);
  verslice = curvechart().width(wright - margin.left - margin.right).height(htop - margin.top - margin.bottom).margin(margin).axispos(axispos).titlepos(titlepos).rectcolor(rectcolor).xlim(ylim).ylim(d3.extent(zlim)).nxticks(nyticks).xticks(yticks).nyticks(nzticks).yticks(zticks).xlab(ylab).ylab(zlab).strokecolor("").commonX(true);
  g_heatmap = svg.append("g").attr("id", "heatmap").datum(data).call(myheatmap);
  formatX = formatAxis(data.x);
  formatY = formatAxis(data.y);
  cells = myheatmap.cellSelect().on("mouseover", function(d, i) {
    g_verslice.select("g.title text").text("X = " + (formatX(d.x)));
    g_horslice.select("g.title text").text("Y = " + (formatY(d.y)));
    plotVer(d.i);
    return plotHor(d.j);
  }).on("mouseout", function(d, i) {
    g_verslice.select("g.title text").text("");
    g_horslice.select("g.title text").text("");
    removeVer();
    return removeHor();
  });
  g_horslice = svg.append("g").attr("id", "horslice").attr("transform", "translate(0," + htop + ")").datum({
    x: data.x,
    data: [pullVarAsArray(data.z, 0)]
  }).call(horslice);
  g_verslice = svg.append("g").attr("id", "verslice").attr("transform", "translate(" + wleft + ",0)").datum({
    x: data.y,
    data: [data.z[0]]
  }).call(verslice);
  horcurvefunc = function(j) {
    return d3.svg.line().x(function(d) {
      return horslice.xscale()(d);
    }).y(function(d, i) {
      return horslice.yscale()(data.z[i][j]);
    });
  };
  vercurvefunc = function(i) {
    return d3.svg.line().x(function(d) {
      return verslice.xscale()(d);
    }).y(function(d, j) {
      return verslice.yscale()(data.z[i][j]);
    });
  };
  plotHor = function(j) {
    return g_horslice.append("g").attr("id", "horcurve").append("path").datum(data.x).attr("d", horcurvefunc(j)).attr("stroke", strokecolor).attr("fill", "none").attr("stroke-width", strokewidth).attr("style", "pointer-events", "none");
  };
  removeHor = function() {
    return g_horslice.selectAll("g#horcurve").remove();
  };
  plotVer = function(i) {
    return g_verslice.append("g").attr("id", "vercurve").append("path").datum(data.y).attr("d", vercurvefunc(i)).attr("stroke", strokecolor).attr("fill", "none").attr("stroke-width", strokewidth).attr("style", "pointer-events", "none");
  };
  return removeVer = function() {
    return g_verslice.selectAll("g#vercurve").remove();
  };
};
